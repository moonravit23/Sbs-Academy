/*
 * ê²Œì„ì˜ ì‹œì‘í™”ë©´ ë§Œë“¤ê¸°
 * ë©”ì¸ -  ë©”ì¸ í™”ë©´ ê¸€ì í‘œì‹œí•˜ê¸° ex) í™˜ì˜ì¸ì‚¬
 * 1. ê²Œì„ì‹œì‘
 * 2. ë‚˜ê°€ê¸°
 *  
 *2ë²ˆì„ ëˆŒë €ì„ë•Œ ê²Œì„ ì¢…ë£Œí•˜ê¸°
 *
 *2ë²ˆì„ ì…ë ¥í•˜ê¸° ì „ê¹Œì§€ ê³„ì† ê¸€ìë¥¼ ë‹¤ì‹œ ì¶œë ¥í•˜ê³  ì…ë ¥ì„ ë‹¤ì‹œë°›ê¸°.
 *
 *1ë²ˆì„ ëˆŒëŸ¬ì„œ ê²Œì„ì‹œì‘ì„ ì„ íƒí•˜ë©´ ìºë¦­í„° ì´ë¦„ì„ í™”ë©´ì— ë„ìš°ê¸°
 *"ìš©ì‚¬ë‹˜ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?"
 *ì´ë¦„ì„ ì…ë ¥í•˜ê³  ë‚˜ì„œ ê²Œì„ì˜ ë©”ì¸í™”ë©´ ë„ìš°ê¸°
 *ë©”ì¸í™”ë©´ì—ëŠ” ìºë¦­í„°ì˜ ì´ë¦„ì´ ë‚˜ì™€ì•¼ í•œë‹¤. {?}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤
 *1.ë˜ì „ì…ì¥
 *2.ìƒíƒœí™•ì¸
 *3.ê²Œì„ì¢…ë£Œ
 */

using System;
using System.Collections.Generic;
using System.Threading.Tasks;

enum ElementType { None, Fire, Water, Electro, Ice }

class Skill
{
    public string Name;
    public int Damage;
    public ElementType Element;
    public int Cooldown;
    public int CurrentCooldown;

    public Skill(string name, int damage, ElementType element, int cooldown = 0)
    {
        Name = name;
        Damage = damage;
        Element = element;
        Cooldown = cooldown;
        CurrentCooldown = 0;
    }
}

class Character
{
    public string Name;
    public ElementType Element;
    public int MaxHP;
    public int CurrentHP;
    public int Attack;
    public int Level = 1;
    public int XP = 0;
    public List<Skill> Skills = new List<Skill>();

    public Character(string name, ElementType element, int hp, int attack)
    {
        Name = name;
        Element = element;
        MaxHP = hp;
        CurrentHP = hp;
        Attack = attack;
    }

    public void GainXP(int amount)
    {
        XP += amount;
        while (XP >= 100)
        {
            XP -= 100;
            LevelUp();
        }
    }

    private void LevelUp()
    {
        Level++;
        MaxHP += 15;
        Attack += 5;
        foreach (var sk in Skills) sk.Damage += 5;
        CurrentHP = MaxHP;
        Console.ForegroundColor = ConsoleColor.Yellow;
        Console.WriteLine($"{Name} ë ˆë²¨ì—…! ë ˆë²¨ {Level} | HP {MaxHP} | ê³µê²©ë ¥ {Attack}");
        Console.ResetColor();
        Task.Delay(1200).Wait();
    }

    public void ReduceCooldowns()
    {
        foreach (var sk in Skills)
            if (sk.CurrentCooldown > 0) sk.CurrentCooldown--;
    }
}

class Enemy
{
    public string Name;
    public int MaxHP;
    public int HP;
    public int Attack;
    public ElementType Element = ElementType.None;
    public List<Skill> Skills = new List<Skill>();
    public bool IsBoss;

    public Enemy(string name, int hp, int attack, bool isBoss = false)
    {
        Name = name;
        MaxHP = hp;
        HP = hp;
        Attack = attack;
        IsBoss = isBoss;
    }

    public void AddSkill(Skill skill) => Skills.Add(skill);
}

class Program
{
    static List<Character> party = new List<Character>();
    static Enemy enemy;
    static string playerName = "";
    static List<Enemy> monsters = new List<Enemy>();
    static Random rand = new Random();

    static void Main()
    {
        StartScreen();
        InitCharacters();
        InitMonsters();
        MainLoop();
    }

    static void StartScreen()
    {
        while (true)
        {
            Console.Clear();
            Console.WriteLine("\n       Genshin Impect Word.ver \n");
            Console.WriteLine("1. ê²Œì„ ì‹œì‘");
            Console.WriteLine("2. ë‚˜ê°€ê¸°\n");
            Console.Write("ì„ íƒí•˜ì„¸ìš”: ");
            string input = Console.ReadLine();

            if (input == "1")
            {
                Console.Write("\në‹¹ì‹ ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”? ");
                playerName = Console.ReadLine();
                break;
            }
            else if (input == "2") Environment.Exit(0);
            else { Console.WriteLine("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤."); Task.Delay(1000).Wait(); }
        }
    }

    static void InitCharacters()
    {
        var huTao = new Character("í˜¸ë‘", ElementType.Fire, 80, 25);
        huTao.Skills.Add(new Skill("ì¼ë°˜ ê³µê²©", 25, ElementType.Fire));
        huTao.Skills.Add(new Skill("ë¶ˆê½ƒ í­ë°œ", 50, ElementType.Fire, 3));
        huTao.Skills.Add(new Skill("ê·€ë©¸ì˜ ë¶ˆê½ƒ(ê¶ê·¹ê¸°)", 100, ElementType.Fire, 5));

        var furina = new Character("í‘¸ë¦¬ë‚˜", ElementType.Water, 120, 12);
        furina.Skills.Add(new Skill("ì¼ë°˜ ê³µê²©", 12, ElementType.Water));
        furina.Skills.Add(new Skill("ë¬¼ëŒ€í¬", 35, ElementType.Water, 2));
        furina.Skills.Add(new Skill("í­í’ì˜ ì§„ì£¼(ê¶ê·¹ê¸°)", 90, ElementType.Water, 5));

        var lisa = new Character("ë¦¬ì‚¬", ElementType.Electro, 90, 18);
        lisa.Skills.Add(new Skill("ì¼ë°˜ ê³µê²©", 18, ElementType.Electro));
        lisa.Skills.Add(new Skill("ë²ˆê°œ ì¶©ê²©", 40, ElementType.Electro, 3));
        lisa.Skills.Add(new Skill("ì¬ë” ìŠ¤í†°(ê¶ê·¹ê¸°)", 95, ElementType.Electro, 5));

        var kaeya = new Character("ì¼€ì´ì•„", ElementType.Ice, 110, 14);
        kaeya.Skills.Add(new Skill("ì¼ë°˜ ê³µê²©", 14, ElementType.Ice));
        kaeya.Skills.Add(new Skill("ì–¼ìŒ ì¹¼ë‚ ", 30, ElementType.Ice, 2));
        kaeya.Skills.Add(new Skill("ë¹™ê²° í­í’(ê¶ê·¹ê¸°)", 80, ElementType.Ice, 5));

        party.AddRange(new[] { huTao, furina, lisa, kaeya });
    }

    static void InitMonsters()
    {
        var slime = new Enemy("ìŠ¬ë¼ì„", 200, 15);
        slime.AddSkill(new Skill("ë¬¼ íŠ€ê¸°ê¸°", 20, ElementType.Water));
        slime.AddSkill(new Skill("í‰íƒ€", 15, ElementType.None));

        var boss = new Enemy("ë³´ìŠ¤: í™”ì—¼ ê³¨ë ˜", 400, 25, true);
        boss.AddSkill(new Skill("í™”ì—¼ ëŒì§„", 50, ElementType.Fire));
        boss.AddSkill(new Skill("ê°•íƒ€", 30, ElementType.None));

        monsters.AddRange(new[] { slime, boss });
    }

    static void MainLoop()
    {
        while (true)
        {
            Console.Clear();
            Console.WriteLine($"{playerName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!\n");
            Console.WriteLine("1. ëª¬ë“œì„¬ ì…ì¥");
            Console.WriteLine("2. ìƒíƒœ í™•ì¸");
            Console.WriteLine("3. ê²Œì„ ì¢…ë£Œ\n");
            Console.Write("ì„ íƒí•˜ì„¸ìš”: ");
            string input = Console.ReadLine();

            if (input == "1") ChooseMonster();
            else if (input == "2") ShowPartyStatus();
            else if (input == "3") Environment.Exit(0);
            else { Console.WriteLine("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤."); Task.Delay(1000).Wait(); }
        }
    }

    static void ChooseMonster()
    {
        Console.Clear();
        Console.WriteLine("=== ëª¬ìŠ¤í„° ì„ íƒ ===\n");
        for (int i = 0; i < monsters.Count; i++)
        {
            var m = monsters[i];
            Console.WriteLine($"{i + 1}. {m.Name} (HP: {m.HP}, ê³µê²©ë ¥: {m.Attack})");
        }

        Console.Write("\nì„ íƒí•˜ì„¸ìš”: ");
        if (int.TryParse(Console.ReadLine(), out int index) && index > 0 && index <= monsters.Count)
        {
            Enemy template = monsters[index - 1];
            enemy = new Enemy(template.Name, template.MaxHP, template.Attack, template.IsBoss);
            foreach (var sk in template.Skills)
                enemy.AddSkill(new Skill(sk.Name, sk.Damage, sk.Element, sk.Cooldown));
            EnterBattle().Wait();
        }
        else { Console.WriteLine("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤."); Task.Delay(1000).Wait(); }
    }

    static async Task EnterBattle()
    {
        while (enemy.HP > 0)
        {
            if (!AnyAlive())
            {
                Console.WriteLine("ëª¨ë“  ìºë¦­í„°ê°€ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤! íŒ¨ë°°...");
                await Task.Delay(1500);
                return;
            }

            Console.Clear();
            Console.WriteLine($"=== ì „íˆ¬ ì‹œì‘ === ì : {enemy.Name} HP: {enemy.HP}/{enemy.MaxHP} | ì›ì†Œ: {enemy.Element}\n");

            int totalDamage = 0;
            ElementType combo = ElementType.None;

            foreach (var c in party)
            {
                if (c.CurrentHP <= 0) continue;

                Skill selectedSkill = ChooseSkill(c); // ìŠ¤í‚¬ ì„ íƒ
                selectedSkill.CurrentCooldown = selectedSkill.Cooldown;

                await ColorTextCinematic($"{c.Name} ìŠ¤í‚¬ ì‚¬ìš©: {selectedSkill.Name}", selectedSkill.Element);

                int dmg = selectedSkill.Damage;

                // ì›ì†Œ ë°˜ì‘ ì²˜ë¦¬
                if (combo == ElementType.Water && selectedSkill.Element == ElementType.Fire)
                {
                    dmg *= 2;
                    await ColorTextCinematic("ğŸ’¥ ì¦ë°œ ë°œìƒ! x2", ConsoleColor.Red);
                }
                else if (combo == ElementType.Fire && selectedSkill.Element == ElementType.Water)
                {
                    dmg = (int)(dmg * 1.5);
                    await ColorTextCinematic("ğŸ’¥ ì¦ë°œ ë°œìƒ! x1.5", ConsoleColor.Cyan);
                }
                else if (combo == ElementType.Fire && selectedSkill.Element == ElementType.Electro)
                {
                    dmg += 10;
                    await ColorTextCinematic("âš¡ ê³¼ë¶€í•˜ ë°œìƒ! +10", ConsoleColor.Yellow);
                }

                totalDamage += dmg;
                combo = selectedSkill.Element;
            }

            // ëª¬ìŠ¤í„° ê¸°ë³¸ ë°ë¯¸ì§€ ë³´ë„ˆìŠ¤
            int bonus = enemy.IsBoss ? 30 : 15;
            totalDamage += bonus;
            enemy.HP -= totalDamage;
            enemy.Element = combo;

            await ColorTextCinematic($"\nğŸ’¥ ì´í•© ë°ë¯¸ì§€: {totalDamage} | ëª¬ìŠ¤í„° HP ë‚¨ìŒ: {Math.Max(enemy.HP, 0)}", ConsoleColor.Magenta);

            foreach (var c in party) c.ReduceCooldowns();
            await Task.Delay(1000);

            if (enemy.HP <= 0)
            {
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("\nì ì„ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤! XP íšë“!");
                Console.ResetColor();
                foreach (var c in party) if (c.CurrentHP > 0) c.GainXP(50);
                await Task.Delay(1500);
                return;
            }

            await EnemyTurn();
        }
    }

    static Skill ChooseSkill(Character c)
    {
        while (true)
        {
            Console.WriteLine($"\n{c.Name}ì˜ ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”:");
            for (int i = 0; i < c.Skills.Count; i++)
            {
                Skill sk = c.Skills[i];
                string cd = sk.CurrentCooldown > 0 ? $"(ì¿¨ë‹¤ìš´ {sk.CurrentCooldown})" : "";
                Console.WriteLine($"{i + 1}. {sk.Name} {cd}");
            }

            Console.Write("ì„ íƒ: ");
            if (int.TryParse(Console.ReadLine(), out int choice) && choice > 0 && choice <= c.Skills.Count)
            {
                Skill sk = c.Skills[choice - 1];
                if (sk.CurrentCooldown > 0)
                {
                    Console.WriteLine("ì¿¨ë‹¤ìš´ ì¤‘ì¸ ìŠ¤í‚¬ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”.");
                    continue;
                }
                return sk;
            }
            Console.WriteLine("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
        }
    }

    static async Task ColorTextCinematic(string text, ElementType element)
    {
        ConsoleColor color = element switch
        {
            ElementType.Fire => ConsoleColor.Red,
            ElementType.Water => ConsoleColor.Cyan,
            ElementType.Electro => ConsoleColor.Yellow,
            ElementType.Ice => ConsoleColor.Blue,
            _ => ConsoleColor.White
        };
        await ScreenShakeEffect(text, color);
    }

    static async Task ColorTextCinematic(string text, ConsoleColor color)
    {
        await ScreenShakeEffect(text, color);
    }

    static async Task ScreenShakeEffect(string text, ConsoleColor color)
    {
        Console.ForegroundColor = color;
        int delay = 2000 / Math.Max(text.Length, 1); // 2ì´ˆ ê¸°ì¤€ í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë§ì¶° ë”œë ˆì´
        for (int i = 0; i < 3; i++)
        {
            Console.Clear();
            int spaces = rand.Next(0, 5);
            Console.WriteLine(new string(' ', spaces) + text);
            await Task.Delay(delay);
        }
        Console.WriteLine(text);
        Console.ResetColor();
        await Task.Delay(200);
    }

    static bool AnyAlive()
    {
        foreach (var c in party) if (c.CurrentHP > 0) return true;
        return false;
    }

    static async Task EnemyTurn()
    {
        Character target = party[rand.Next(party.Count)];
        while (target.CurrentHP <= 0) target = party[rand.Next(party.Count)];

        Skill sk = enemy.Skills[rand.Next(enemy.Skills.Count)];
        int dmg = sk.Damage;
        target.CurrentHP -= dmg;

        await ColorTextCinematic($"\n{enemy.Name} ìŠ¤í‚¬ ì‚¬ìš©: {sk.Name} â†’ {target.Name}ì—ê²Œ {dmg} í”¼í•´!", ConsoleColor.DarkRed);
        await Task.Delay(2000);
    }

    static void ShowPartyStatus()
    {
        Console.Clear();
        Console.WriteLine("=== íŒŒí‹° ìƒíƒœ ===\n");
        foreach (var c in party)
            Console.WriteLine($"{c.Name} | ì›ì†Œ: {c.Element} | ë ˆë²¨: {c.Level} | HP: {c.CurrentHP}/{c.MaxHP} | ê³µê²©ë ¥: {c.Attack} | XP: {c.XP}/100");

        Console.WriteLine("\nì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ì„¸ìš”...");
        Console.ReadKey();
    }
}
